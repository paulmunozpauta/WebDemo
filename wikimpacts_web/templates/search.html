{% extends "layout.html" %}

{% block content %}

<!-- Page Title -->
<h2>Explore the database</h2>

<!-- Main Search Option Buttons -->
<div class="search-buttons">
    <button type="button" class="btn btn-primary btn-block mb-3" onclick="showSection('impactSearch')">Search by Impact</button>
    <button type="button" class="btn btn-primary btn-block mb-3" onclick="showSection('locationSearch')">Search by Location</button>
    <button type="button" class="btn btn-primary btn-block mb-3" onclick="showSection('customSearch')">Customized Search</button>
</div>

<!-- Search Form Sections (Initially Hidden) -->

<!-- Search by Impact Section -->

<div id="impactSearch" class="search-section" style="display: none;">
    <h3>Search by Impact</h3>
    <form action="{{ url_for('search') }}" method="post">
        
        <!-- All Impacts Option -->
        <div class="form-group">
            <input type="checkbox" id="all_impacts" name="all_impacts" value="all" onchange="toggleAllImpacts(this)">
            <label for="all_impacts"><em>All Impacts</em></label>
        </div>

        <!-- Impact Checklist with Refine by Range Options -->
        <div class="form-group" id="individual_impacts">
            <label>Select Impacts:</label>
            <div>
                {% for impact in ['Total Deaths', 'Total Injuries', 'Total Displacement', 'Total Homelessness', 'Total Insured Damage', 'Total Damage', 'Total Buildings Damage'] %}
                    <div class="form-check d-flex align-items-center">
                        <!-- Individual Impact Checkbox -->
                        <input type="checkbox" class="form-check-input impact-checkbox" id="{{ impact | lower | replace(' ', '_') }}" name="impacts" value="{{ impact }}" onchange="toggleIndividualImpact(this)">
                        <label class="form-check-label mr-3" for="{{ impact | lower | replace(' ', '_') }}">{{ impact }}</label>
                        
                        <!-- Refine by Range Checkbox and Min/Max Inputs -->
                        <div id="{{ impact | lower | replace(' ', '_') }}_options" class="ml-3" style="display: none; align-items: center;">
                            <input type="checkbox" class="form-check-input" id="{{ impact | lower | replace(' ', '_') }}_use_range" name="{{ impact | lower | replace(' ', '_') }}_use_range" onchange="toggleImpactRangeInputs('{{ impact | lower | replace(' ', '_') }}')">
                            <label class="form-check-label ml-2" for="{{ impact | lower | replace(' ', '_') }}_use_range">Refine by range</label>
                            
                            <!-- Min/Max Inputs for Range (initially hidden, with min=0 to prevent negative values) -->
                            <div id="{{ impact | lower | replace(' ', '_') }}_range_inputs" class="ml-3" style="display: none;">
                                <input type="number" class="form-control d-inline" style="width: 80px;" name="{{ impact | lower | replace(' ', '_') }}_min" placeholder="Min" min="0">
                                <input type="number" class="form-control d-inline ml-2" style="width: 80px;" name="{{ impact | lower | replace(' ', '_') }}_max" placeholder="Max" min="0">
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Search Button -->
        <button type="submit" class="btn btn-primary mt-3">Search</button>
    </form>
</div>



<!-- Search by Location Section -->
<div id="locationSearch" class="search-section" style="display: none;">
    <h3>Search by Location</h3>
    <form action="{{ url_for('search') }}" method="post">
        <!-- Country Dropdown with Search Functionality -->
        <div class="form-group">
            <label for="country">Country:</label>
            <select name="country" id="country" class="form-control">
                <option value="">All countries</option>
                {% for country in countries %}
                    <option value="{{ country }}">{{ country }}</option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Event Type Dropdown -->
        <div class="form-group">
            <label for="event_type">Event Type:</label>
            <select name="event_type" id="event_type" class="form-control">
                <option value="all">All Event Types</option>
                {% for event in events %}
                    <option value="{{ event }}">{{ event }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Search Button -->
        <button type="submit" class="btn btn-primary">Search</button>
    </form>
</div>

<!-- Customized Search Section -->
<div id="customSearch" class="search-section" style="display: none;">
    <h3>Customized Search</h3>
    <form action="{{ url_for('search') }}" method="post">
        <!-- Country Dropdown with Search Functionality -->
        <div class="form-group">
            <label for="country">Country:</label>
            <select name="country" id="country" class="form-control">
                <option value="">All countries</option>
                {% for country in countries %}
                    <option value="{{ country }}">{{ country }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Event Type Dropdown -->
        <div class="form-group">
            <label for="event_type">Event Type:</label>
            <select name="event_type" id="event_type" class="form-control">
                <option value="all">All Event Types</option>
                {% for event in events %}
                    <option value="{{ event }}">{{ event }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Impact Type and Value Fields -->
        <div class="form-group">
            <label for="impact">Impact:</label>
            <select name="impact" id="impact" class="form-control">
                <option value="Total_Deaths">Total Deaths</option>
                <option value="Total_Injuries">Total Injuries</option>
                <option value="Total_Displacement">Total Displacement</option>
                <option value="Total_Homelessness">Total Homelessness</option>
                <option value="Total_Insured_Damage">Total Insured Damage</option>
                <option value="Total_Damage">Total Damage</option>
                <option value="Total_Buildings_Damage">Total Buildings Damage</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="impact_value">Impact Value:</label>
            <input type="number" name="impact_value" id="impact_value" class="form-control" placeholder="Enter impact value">
            <small class="form-text text-muted">Enter a value to find events with impacts greater than or equal to this value.</small>
        </div>

        <!-- Events Since Year Field -->
        <div class="form-group">
            <label for="since_year">Events Since Year:</label>
            <input type="number" name="since_year" id="since_year" class="form-control" placeholder="Enter year">
        </div>

        <!-- Search Button -->
        <button type="submit" class="btn btn-primary">Search</button>
    </form>
</div>

<!-- Include Select2 CSS and JavaScript -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<!-- Initialize Select2 on the Country Dropdown -->
<script>
    $(document).ready(function() {
        $('#country').select2({
            placeholder: "Type to search a country",
            allowClear: true
        });
    });

    // Function to show the relevant search section based on the button clicked
    function showSection(sectionId) {
        // Hide all search sections
        $('.search-section').hide();
        // Show the selected section
        $('#' + sectionId).show();
    }
</script>

<!-- JavaScript to Handle All Impacts and Individual Impact Options -->
<script>
    // Function to toggle all individual impact checkboxes and options
    function toggleAllImpacts(allImpactsCheckbox) {
        const isChecked = allImpactsCheckbox.checked;
        
        // Disable/enable individual impacts and hide/show refine options if "All Impacts" is selected/deselected
        document.querySelectorAll('.impact-checkbox').forEach(checkbox => {
            checkbox.checked = false;
            checkbox.disabled = isChecked;
            document.getElementById(checkbox.id + '_options').style.display = 'none'; // Hide refine options
            toggleImpactRangeInputs(checkbox.id, false); // Hide range inputs
        });
    }

    // Function to manage individual impact selections and uncheck "All Impacts" if necessary
    function toggleIndividualImpact(individualCheckbox) {
        const allImpactsCheckbox = document.getElementById('all_impacts');
        const refineOptionsDiv = document.getElementById(individualCheckbox.id + '_options');

        // Show or hide the "Refine by range" option based on the checkbox state
        if (individualCheckbox.checked) {
            allImpactsCheckbox.checked = false;
            allImpactsCheckbox.disabled = true;
            refineOptionsDiv.style.display = 'inline-flex'; // Show refine option
        } else {
            refineOptionsDiv.style.display = 'none'; // Hide refine option if impact unchecked
        }

        // If no individual impacts are selected, re-enable "All Impacts"
        const anyChecked = Array.from(document.querySelectorAll('.impact-checkbox')).some(cb => cb.checked);
        if (!anyChecked) {
            allImpactsCheckbox.disabled = false;
        }
    }

    // Function to toggle min/max input fields for each impact based on "Refine by range" selection
    function toggleImpactRangeInputs(impactId, showInputs = null) {
        const rangeCheckbox = document.getElementById(impactId + '_use_range');
        const inputsDiv = document.getElementById(impactId + '_range_inputs');
        
        // Show/hide the min/max inputs based on the checkbox status
        inputsDiv.style.display = rangeCheckbox.checked ? 'block' : 'none';
    }
</script>
{% endblock %}
